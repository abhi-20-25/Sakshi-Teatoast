<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakshi.AI - Dashboard</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-primary: #0D1117; --bg-secondary: #161B22; --border-color: #30363D; --text-primary: #C9D1D9; --text-secondary: #8B949E; --accent-color: #238636; --accent-hover: #2ea043; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-primary); color: var(--text-primary); }
        .glass-nav { background: rgba(13, 17, 23, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .header { padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; }
        .header-logo { display: flex; align-items: center; gap: 12px; }
        .header h1 { margin: 0; font-size: 1.5em; font-weight: 700; color: #fff; }
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .app-section { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 25px; }
        .app-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .app-header h2 { margin: 0; font-size: 1.2em; }
        .app-header .status { font-size: 0.9em; color: var(--text-secondary); }
        .app-header .status .online-dot { display: inline-block; width: 8px; height: 8px; background-color: var(--accent-color); border-radius: 50%; margin-right: 6px; }
        .app-content { padding: 20px; }
        .btn { padding: 8px 16px; cursor: pointer; border: 1px solid var(--border-color); background-color: #21262d; color: var(--text-primary); border-radius: 6px; transition: background-color 0.2s; }
        .btn:hover { background-color: var(--border-color); }
        .btn-primary { background-color: var(--accent-color); border-color: var(--accent-color); color: #fff; text-decoration: none; }
        .btn-primary:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); }
        .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; min-height: 200px; }
        .history-item { border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; background-color: var(--bg-primary); transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; }
        .history-item:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .history-item img { width: 100%; aspect-ratio: 4/3; object-fit: cover; background: #000; }
        .history-item-info { padding: 10px; font-size: 0.8em; }
        .history-item-info p { margin: 0 0 5px 0; color: var(--text-secondary); }
        .history-item-info strong { color: var(--text-primary); }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { padding: 8px 16px; margin: 0 5px; cursor: pointer; border: 1px solid var(--border-color); background-color: #21262d; color: var(--text-primary); border-radius: 6px; }
        .pagination button:disabled { cursor: not-allowed; opacity: 0.5; }
        .layout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stream-box { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; max-width: 100%; position: relative; }
        .stream-box img { width: 100%; display: block; background-color: #000; }
        .stream-header, .stream-footer { padding: 10px; background-color: var(--bg-primary); font-weight: bold; }
        .stream-header { font-size: 0.9em; text-align: left; }
        .stream-footer { font-size: 1.1em; text-align: center; }
        .report-section { flex-grow: 1; min-width: 300px; }
        .report-section input[type="date"] { background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px; border-radius: 4px; }
        .report-section table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-section th, .report-section td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 0.9em; }
        .report-section th { background-color: #21262d; }
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
        .tab-button { padding: 10px 15px; cursor: pointer; background: transparent; color: var(--text-secondary); border: none; border-bottom: 3px solid transparent; font-size: 0.9em; }
        .tab-button.active { border-bottom: 3px solid var(--accent-color); font-weight: bold; color: var(--text-primary); }
        .tab-content { display: none; padding-top: 15px; }
        .tab-content.active { display: block; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--bg-secondary); margin: 5% auto; padding: 25px; border: 1px solid var(--border-color); width: 90%; max-width: 900px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close-btn { color: var(--text-secondary); font-size: 28px; font-weight: bold; cursor: pointer; }
        .report-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .summary-card { background-color: var(--bg-primary); padding: 20px; border-radius: 6px; border: 1px solid var(--border-color); }
        .summary-card h4 { margin: 0 0 5px 0; color: var(--text-secondary); font-size: 0.9em; font-weight: 500; }
        .summary-card p { margin: 0; font-size: 1.5em; font-weight: 600; }
        .lightbox { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        .lightbox img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .lightbox-close { position: absolute; top: 20px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .lightbox-close:hover { color: var(--accent-color); }
        .filter-controls { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 10px; background-color: var(--bg-primary); border-radius: 6px; }
        .roi-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; }
        .roi-controls { display: none; gap: 10px; align-items: center; margin-top: 10px; }
        .roi-controls.active { display: flex; }
        .hidden { display: none !important; }
        @media (max-width: 768px) { .layout-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="antialiased">

<header class="glass-nav sticky top-0 z-50">
    <div class="header max-w-[1400px] mx-auto">
        <div class="header-logo">
            <svg style="width: 2rem; height: 2rem; color: var(--accent-color);" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 18.5C8.97 18.5 6.5 16.03 6.5 13H8.5C8.5 14.93 10.07 16.5 12 16.5C13.93 16.5 15.5 14.93 15.5 13C15.5 11.07 13.93 9.5 12 9.5C10.07 9.5 8.5 11.07 8.5 13H6.5C6.5 9.97 8.97 7.5 12 7.5C15.03 7.5 17.5 9.97 17.5 13C17.5 16.03 15.03 18.5 12 18.5Z" fill="currentColor"/></svg>
            <h1>Sakshi<span style="color: var(--accent-color);">.AI</span> Dashboard</h1>
        </div>
        <a href="/" style="color: var(--text-secondary); font-size: 0.9em; text-decoration: none;">&larr; Back to Landing Page</a>
    </div>
</header>

<div class="container" id="dashboard-container"></div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="reportModalTitle">Footfall Analysis Report</h2>
            <span class="close-btn" onclick="closeReportModal()">&times;</span>
        </div>
        <div class="report-controls">
            <span>Period:</span>
            <button class="btn" onclick="generateReport('7days')">Last 7 Days</button>
            <button class="btn" onclick="generateReport('30days')">Last 30 Days</button>
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <span>Chart Type:</span>
                <button class="btn" id="barChartBtn" onclick="renderChart('bar')">Bar</button>
                <button class="btn" id="lineChartBtn" onclick="renderChart('line')">Line</button>
            </div>
        </div>
        <div id="reportError" style="color: #f87171; margin-bottom: 15px;"></div>
        <div class="summary-cards">
            <div class="summary-card"><h4>Total Footfall</h4><p id="summaryTotal">--</p></div>
            <div class="summary-card"><h4>Busiest Day</h4><p id="summaryDay">--</p></div>
            <div class="summary-card"><h4>Peak Hour (Avg)</h4><p id="summaryHour">--</p></div>
        </div>
        <div><canvas id="reportChart"></canvas></div>
    </div>
</div>

<div id="shutterReportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="shutterReportModalTitle">Shutter Status Report</h2>
            <span class="close-btn" onclick="closeShutterReportModal()">&times;</span>
        </div>
        <div class="report-controls">
            <label for="shutter-report-start">From:</label>
            <input type="date" id="shutter-report-start">
            <label for="shutter-report-end">To:</label>
            <input type="date" id="shutter-report-end">
            <button class="btn btn-primary" onclick="generateShutterReport()">Generate</button>
        </div>
        <div id="shutterReportError" style="color: #f87171; margin-bottom: 15px;"></div>
        <div class="report-section">
            <table id="shutterReportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>First Open</th>
                        <th>First Close</th>
                    </tr>
                </thead>
                <tbody id="shutterReportTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="shutterVideoModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="shutterVideoModalTitle">Shutter Event Video</h2>
            <span class="close-btn" onclick="closeShutterVideoModal()">&times;</span>
        </div>
        <div style="padding: 10px 0;">
            <video id="shutterVideoPlayer" width="100%" controls autoplay muted playsinline>
                Your browser does not support the video tag.
            </video>
        </div>
    </div>
</div>


<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img id="lightbox-img" src="">
</div>

<script>
    const appConfigs = JSON.parse('{{ app_configs|tojson|safe }}');
    const dashboardContainer = document.getElementById('dashboard-container');
    const socket = io();
    let reportChart = null;
    let activeReportChannel = null;
    let currentReportData = {};
    let queueCharts = {};
    let roiDrawingState = {};

    const reportModal = document.getElementById('reportModal');
    const shutterReportModal = document.getElementById('shutterReportModal');
    const shutterVideoModal = document.getElementById('shutterVideoModal');
    const shutterVideoPlayer = document.getElementById('shutterVideoPlayer');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    
    // --- Modal Controls ---
    function openLightbox(imgSrc) { lightboxImg.src = imgSrc; lightbox.style.display = 'flex'; }
    function closeLightbox() { lightbox.style.display = 'none'; }
    function openReportModal(channelId, channelName) {
        document.getElementById('reportModalTitle').textContent = `Footfall Report for ${channelName}`;
        activeReportChannel = channelId; reportModal.style.display = 'block'; generateReport('7days');
    }
    function closeReportModal() { reportModal.style.display = 'none'; if (reportChart) { reportChart.destroy(); reportChart = null; } }
    function openShutterReportModal(channelId, channelName) {
        document.getElementById('shutterReportModalTitle').textContent = `Shutter Report for ${channelName}`;
        activeReportChannel = channelId;
        const today = new Date().toISOString().split('T')[0];
        const sevenDaysAgo = new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        document.getElementById('shutter-report-start').value = sevenDaysAgo;
        document.getElementById('shutter-report-end').value = today;
        shutterReportModal.style.display = 'block';
        generateShutterReport();
    }
    function closeShutterReportModal() { shutterReportModal.style.display = 'none'; }
    function openShutterVideoModal(videoUrl, eventInfo) {
        if (!videoUrl || videoUrl === 'null') { alert("No video available for this event."); return; }
        document.getElementById('shutterVideoModalTitle').textContent = `Video for ${eventInfo}`;
        shutterVideoPlayer.src = videoUrl;
        shutterVideoModal.style.display = 'block';
        shutterVideoPlayer.play().catch(e => console.error("Video autoplay error:", e));
    }
    function closeShutterVideoModal() {
        shutterVideoModal.style.display = 'none';
        shutterVideoPlayer.pause();
        shutterVideoPlayer.src = '';
    }

    // --- ROI Drawing ---
    function startRoiEdit(appName, channelId) {
        const streamBox = document.getElementById(`stream-box-${appName}-${channelId}`);
        const canvas = streamBox.querySelector('.roi-canvas');
        const controls = streamBox.querySelector('.roi-controls');
        canvas.style.display = 'block';
        controls.classList.add('active');
        roiDrawingState[channelId] = { points: { main: [], secondary: [] }, currentPoly: 'main' };
        redrawRoiCanvas(appName, channelId);
    }
    function cancelRoiEdit(appName, channelId) {
        const streamBox = document.getElementById(`stream-box-${appName}-${channelId}`);
        streamBox.querySelector('.roi-canvas').style.display = 'none';
        streamBox.querySelector('.roi-controls').classList.remove('active');
        delete roiDrawingState[channelId];
    }
    function resetRoi(appName, channelId) {
        if (roiDrawingState[channelId]) {
            roiDrawingState[channelId].points[roiDrawingState[channelId].currentPoly] = [];
            redrawRoiCanvas(appName, channelId);
        }
    }
    async function saveRoi(appName, channelId) {
        const state = roiDrawingState[channelId];
        if (!state) return;
        const canvas = document.getElementById(`stream-box-${appName}-${channelId}`).querySelector('.roi-canvas');
        const normalizedPoints = {
            main: state.points.main.map(p => [p.x / canvas.width, p.y / canvas.height]),
            secondary: state.points.secondary.map(p => [p.x / canvas.width, p.y / canvas.height])
        };
        const response = await fetch('/api/set_roi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appName, channel_id: channelId, roi_points: normalizedPoints })
        });
        const result = await response.json();
        alert(result.success ? 'ROI saved successfully!' : `Error: ${result.error}`);
        if(result.success) cancelRoiEdit(appName, channelId);
    }
    function handleCanvasClick(event, appName, channelId) {
        const state = roiDrawingState[channelId];
        if (!state) return;
        const canvas = event.target;
        const rect = canvas.getBoundingClientRect();
        state.points[state.currentPoly].push({ x: event.clientX - rect.left, y: event.clientY - rect.top });
        redrawRoiCanvas(appName, channelId);
    }
    function redrawRoiCanvas(appName, channelId) {
        const state = roiDrawingState[channelId];
        if (!state) return;
        const canvas = document.getElementById(`stream-box-${appName}-${channelId}`).querySelector('.roi-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawPolygon(ctx, state.points.main, 'rgba(255, 255, 0, 0.8)', 'rgba(255, 255, 0, 0.2)');
        drawPolygon(ctx, state.points.secondary, 'rgba(0, 255, 255, 0.8)', 'rgba(0, 255, 255, 0.2)');
    }
    function drawPolygon(ctx, points, strokeColor, fillColor) {
        if (points.length === 0) return;
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        points.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
        if (points.length > 2) ctx.closePath();
        ctx.strokeStyle = strokeColor; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = fillColor; ctx.fill();
        points.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI); ctx.fillStyle = strokeColor; ctx.fill(); });
    }

    // --- Report Generation ---
    async function generateReport(period) {
        if (!activeReportChannel) return;
        const errorEl = document.getElementById('reportError'); errorEl.textContent = 'Loading...';
        const response = await fetch(`/generate_report/${activeReportChannel}?period=${period}`);
        const data = await response.json();
        if (data.error) { errorEl.textContent = data.error; return; }
        errorEl.textContent = ''; currentReportData = data;
        document.getElementById('summaryTotal').textContent = data.summary.total_footfall;
        document.getElementById('summaryDay').textContent = data.summary.busiest_day;
        document.getElementById('summaryHour').textContent = data.summary.peak_hour;
        renderChart('bar');
    }
    function renderChart(type) {
        if (!currentReportData.labels) return;
        const ctx = document.getElementById('reportChart').getContext('2d');
        if (reportChart) reportChart.destroy();
        reportChart = new Chart(ctx, { type: type, data: { labels: currentReportData.labels, datasets: [{ label: 'Total Visitors', data: currentReportData.data, backgroundColor: 'rgba(35, 134, 54, 0.5)', borderColor: 'rgba(46, 160, 67, 1)', tension: 0.1 }] }, options: { scales: { y: { beginAtZero: true, grid: { color: 'rgba(201, 209, 217, 0.1)' }, ticks: { color: 'var(--text-secondary)'} }, x: { grid: { color: 'rgba(201, 209, 217, 0.1)' }, ticks: { color: 'var(--text-secondary)'} } }, plugins: { legend: { labels: { color: 'var(--text-primary)' } } } } });
    }
    async function fetchHistory(appName, page = 1, channelId = null, startDate = null, endDate = null) {
        const grid = document.getElementById(`grid-${appName}-${channelId}`);
        const pagination = document.getElementById(`pagination-${appName}-${channelId}`);
        if (!grid) return;
        let url = `/history/${appName}?page=${page}&limit=10&channel_id=${channelId}`;
        if (startDate && endDate) url += `&start_date=${startDate}&end_date=${endDate}`;
        grid.innerHTML = '<p>Loading history...</p>';
        const response = await fetch(url);
        const data = await response.json();
        grid.innerHTML = data.detections.length === 0 ? '<p>No detections found.</p>' : '';
        data.detections.forEach(d => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `<img src="${d.media_url}" alt="Detection" loading="lazy" onclick="openLightbox('${d.media_url}')"><div class="history-item-info"><p><strong>Message:</strong> ${d.message}</p><p><strong>Time:</strong> ${d.timestamp}</p></div>`;
            grid.appendChild(item);
        });
        if (pagination) {
            pagination.innerHTML = '';
            const totalPages = Math.ceil(data.total / data.limit);
            if (totalPages > 1) {
                const prev = document.createElement('button'); prev.textContent = '<'; prev.disabled = data.page === 1;
                prev.onclick = () => fetchHistory(appName, data.page - 1, channelId, startDate, endDate);
                const next = document.createElement('button'); next.textContent = '>'; next.disabled = data.page >= totalPages;
                next.onclick = () => fetchHistory(appName, data.page + 1, channelId, startDate, endDate);
                pagination.append(prev, ` Page ${data.page} of ${totalPages} `, next);
            }
        }
    }
    function applyDateFilter(appName, channelId) {
        const startDate = document.getElementById(`start-date-${appName}-${channelId}`).value;
        const endDate = document.getElementById(`end-date-${appName}-${channelId}`).value;
        fetchHistory(appName, 1, channelId, startDate, endDate);
    }
    async function fetchPCReport(channelId, date) {
        const tableBody = document.getElementById(`pc-report-table-${channelId}`);
        if (!tableBody) return;
        tableBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
        const response = await fetch(`/report/${channelId}/${date}`);
        const data = await response.json();
        tableBody.innerHTML = '';
        Object.entries(data.hourly_data).forEach(([hour, counts]) => {
            const hourFormatted = new Date(0,0,0,hour).toLocaleTimeString('en-US', {hour: 'numeric', hour12: true});
            tableBody.innerHTML += `<tr><td>${hourFormatted}</td><td>${counts.in}</td><td>${counts.out}</td></tr>`;
        });
    }
    async function generateShutterReport() {
        if (!activeReportChannel) return;
        const startDate = document.getElementById('shutter-report-start').value;
        const endDate = document.getElementById('shutter-report-end').value;
        const errorEl = document.getElementById('shutterReportError');
        const tableBody = document.getElementById('shutterReportTableBody');
        errorEl.textContent = 'Loading...'; tableBody.innerHTML = '';
        const response = await fetch(`/shutter_report/${activeReportChannel}?start_date=${startDate}&end_date=${endDate}`);
        const data = await response.json();
        errorEl.textContent = data.error || '';
        if(data.report_data) data.report_data.forEach(row => {
            const openCell = row.first_open_video_url ? `<a href="#" onclick="event.preventDefault(); openShutterVideoModal('${row.first_open_video_url}', 'First Open on ${row.date}')" style="color: var(--accent-hover);">${row.first_open_time}</a>` : row.first_open_time;
            const closeCell = row.first_close_video_url ? `<a href="#" onclick="event.preventDefault(); openShutterVideoModal('${row.first_close_video_url}', 'First Close on ${row.date}')" style="color: var(--accent-hover);">${row.first_close_time}</a>` : row.first_close_time;
            tableBody.innerHTML += `<tr><td>${row.date}</td><td>${openCell}</td><td>${closeCell}</td></tr>`;
        });
    }
    async function fetchSecurityViolations(channelId) {
        const tbody = document.getElementById(`security-tbody-${channelId}`);
        if (!tbody) return;
        const response = await fetch(`/reports/security/${channelId}`);
        const violations = await response.json();
        tbody.innerHTML = violations.length === 0 ? '<tr><td colspan="3">No violations recorded.</td></tr>' : '';
        violations.forEach(v => {
            tbody.innerHTML += `<tr><td>${v.timestamp}</td><td>${v.message}</td><td>${v.details}</td></tr>`;
        });
    }

    // --- Dashboard Generation ---
    function generateDashboard() {
        const savedOrder = JSON.parse(localStorage.getItem('dashboardLayout'));
        const sortedAppNames = savedOrder || Object.keys(appConfigs).sort();

        sortedAppNames.forEach(appName => {
            if (!appConfigs[appName]) return;
            const config = appConfigs[appName];
            if (!config.channels || config.channels.length === 0) return;
            
            const section = document.createElement('div');
            section.className = 'app-section';
            section.dataset.appName = appName;
            
            let contentHTML = '';
            
            if (appName === 'PeopleCounter') {
                const channel = config.channels[0]; const today = new Date().toISOString().split('T')[0];
                contentHTML = `<div class="layout-grid"><div class="stream-box"><div class="stream-header">${channel.name}</div><img src="/video_feed/PeopleCounter/${channel.id}" alt="Live feed"><div class="stream-footer">IN: <span id="in-count-${channel.id}">...</span> | OUT: <span id="out-count-${channel.id}">...</span></div></div><div class="report-section"><h3>Daily Footfall</h3><input type="date" value="${today}" onchange="fetchPCReport('${channel.id}', this.value)"><table><thead><tr><th>Hour</th><th>In</th><th>Out</th></tr></thead><tbody id="pc-report-table-${channel.id}"></tbody></table><button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="openReportModal('${channel.id}', '${channel.name}')">Generate Report</button></div></div>`;
                setTimeout(() => fetchPCReport(channel.id, today), 100);
            } else if (appName === 'ShutterMonitor') {
                const channel = config.channels[0];
                contentHTML = `<div class="summary-cards" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                    <div class="summary-card"><h4>Current Status</h4><p id="shutter-status-${channel.id}">--</p><small id="shutter-status-time-${channel.id}">...</small></div>
                    <div class="summary-card"><h4>First Opening</h4><p id="shutter-first-open-${channel.id}">--</p></div>
                    <div class="summary-card"><h4>First Closing</h4><p id="shutter-first-close-${channel.id}">--</p></div>
                    <div class="summary-card"><h4>Total Open Time</h4><p id="shutter-total-open-${channel.id}">--</p></div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="openShutterReportModal('${channel.id}', '${channel.name}')">Generate Historical Report</button>`;
            } else if (appName === 'Security') {
                const channel = config.channels[0];
                contentHTML = `<div class="layout-grid"><div class="stream-box"><div class="stream-header">${channel.name} - Live</div><img src="/video_feed/Security/${channel.id}" alt="Live feed"></div><div class="report-section"><h3>Recent Violations</h3><table id="security-table-${channel.id}"><thead><tr><th>Timestamp</th><th>Violation</th><th>Details</th></tr></thead><tbody id="security-tbody-${channel.id}"></tbody></table></div></div>`;
                setTimeout(() => fetchSecurityViolations(channel.id), 500);
            } else {
                const videoFeedApp = (['Shoplifting', 'QPOS', 'Generic'].includes(appName)) ? 'Detection' : appName;
                let tabsHTML = ''; let contentDivs = '';
                config.channels.forEach((channel, i) => {
                    const active = i === 0 ? 'active' : '';
                    tabsHTML += `<button class="tab-button ${active}" onclick="openTab(event, '${appName}')">${channel.name}</button>`;
                    contentDivs += `<div id="content-${appName}-${channel.id}" class="tab-content ${active}">
                        <div class="layout-grid">
                            <div class="stream-box" id="stream-box-${appName}-${channel.id}">
                                <div class="stream-header">${channel.name} - Live</div>
                                <img src="/video_feed/${videoFeedApp}/${channel.id}" alt="Live feed">
                                ${appName === 'QueueMonitor' ? `<canvas class="roi-canvas" style="display:none;" onclick="handleCanvasClick(event, '${appName}', '${channel.id}')"></canvas>` : ''}
                                ${appName === 'QueueMonitor' ? `<div class="stream-footer">Queue: <span id="queue-count-${channel.id}">...</span></div>` : ''}
                            </div>
                            <div class="report-section">
                                <h3>Detection History</h3>
                                <div class="filter-controls">
                                    <input type="date" id="start-date-${appName}-${channel.id}">
                                    <input type="date" id="end-date-${appName}-${channel.id}">
                                    <button class="btn" onclick="applyDateFilter('${appName}', '${channel.id}')">Filter</button>
                                    ${appName === 'QueueMonitor' ? `<button class="btn" style="margin-left: auto;" onclick="startRoiEdit('${appName}', '${channel.id}')">Edit ROI</button>` : ''}
                                </div>
                                <div class="roi-controls">
                                    <button class="btn" onclick="roiDrawingState['${channel.id}'].currentPoly = 'main'">Draw Main</button>
                                    <button class="btn" onclick="roiDrawingState['${channel.id}'].currentPoly = 'secondary'">Draw Secondary</button>
                                    <button class="btn" onclick="resetRoi('${appName}', '${channel.id}')">Reset</button>
                                    <button class="btn" onclick="cancelRoiEdit('${appName}', '${channel.id}')">Cancel</button>
                                    <button class="btn btn-primary" onclick="saveRoi('${appName}', '${channel.id}')">Save</button>
                                </div>
                                <div class="history-grid" id="grid-${appName}-${channel.id}"></div>
                                <div class="pagination" id="pagination-${appName}-${channel.id}"></div>
                            </div>
                        </div>
                    </div>`;
                    if (i === 0) setTimeout(() => fetchHistory(appName, 1, channel.id), 200);
                });
                contentHTML = `<div class="tab-nav">${tabsHTML}</div>${contentDivs}`;
            }
            const onlineStatus = `<span class="status"><span class="online-dot"></span>${config.online_count} / ${config.channels.length} Online</span>`;
            section.innerHTML = `<div class="app-header"><h2>${appName.replace(/([A-Z])/g, ' $1').trim()}</h2> ${onlineStatus}</div><div class="app-content">${contentHTML}</div>`;
            dashboardContainer.appendChild(section);
        });
        
        new Sortable(dashboardContainer, { animation: 150, handle: '.app-header', onEnd: (e) => {
            const order = Array.from(dashboardContainer.children).map(el => el.dataset.appName);
            localStorage.setItem('dashboardLayout', JSON.stringify(order));
        }});
    }

    function openTab(evt, appName) {
        const parent = evt.target.closest('.app-content');
        parent.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        parent.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        const channelId = parent.querySelectorAll('.tab-content')[Array.from(evt.target.parentNode.children).indexOf(evt.target)].id.split('-').pop();
        document.getElementById(`content-${appName}-${channelId}`).classList.add('active');
        evt.target.classList.add('active');
        fetchHistory(appName, 1, channelId);
    }
    
    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60);
        return `${h}h ${m}m`;
    }

    // --- Socket.IO Listeners ---
    socket.on('count_update', data => {
        document.getElementById(`in-count-${data.channel_id}`).textContent = data.in_count;
        document.getElementById(`out-count-${data.channel_id}`).textContent = data.out_count;
    });
    socket.on('queue_update', data => {
        const el = document.getElementById(`queue-count-${data.channel_id}`);
        if(el) el.textContent = data.count;
    });
    socket.on('shutter_update', data => {
        document.getElementById(`shutter-status-${data.channel_id}`).textContent = data.last_status.toUpperCase();
        document.getElementById(`shutter-status-time-${data.channel_id}`).textContent = `Since ${new Date(data.last_status_time).toLocaleTimeString()}`;
        document.getElementById(`shutter-first-open-${data.channel_id}`).textContent = data.first_open_time ? new Date(data.first_open_time).toLocaleTimeString() : 'N/A';
        document.getElementById(`shutter-first-close-${data.channel_id}`).textContent = data.first_close_time ? new Date(data.first_close_time).toLocaleTimeString() : 'N/A';
        document.getElementById(`shutter-total-open-${data.channel_id}`).textContent = formatDuration(data.total_open_duration_seconds);
    });
    socket.on('new_detection', data => {
        const activeTab = document.querySelector(`#content-${data.app_name}-${data.channel_id}.active`);
        if (activeTab) fetchHistory(data.app_name, 1, data.channel_id);
    });
    socket.on('security_violation', data => {
        const tbody = document.getElementById(`security-tbody-${data.channel_id}`);
        if (tbody) {
            tbody.insertAdjacentHTML('afterbegin', `<tr><td>${data.timestamp}</td><td>${data.message}</td><td>${data.details}</td></tr>`);
            if (tbody.rows.length > 15) tbody.deleteRow(-1);
        }
    });

    generateDashboard();
</script>
</body>
</html>

